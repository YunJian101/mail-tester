<!DOCTYPE html>
<!-- 
SMTPæµ‹è¯•å·¥å…·å‰ç«¯é¡µé¢
åŠŸèƒ½ï¼š
1. æä¾›SMTPæœåŠ¡å™¨æµ‹è¯•ç•Œé¢
2. æ”¯æŒè‡ªåŠ¨/æ‰‹åŠ¨æµ‹è¯•æ¨¡å¼
3. å®æ—¶æ˜¾ç¤ºæµ‹è¯•æ—¥å¿—
4. åŠ¨æ€åŠ è½½é…ç½®
-->
<html lang="zh-CN">
<head>
    <!-- åŸºç¡€å…ƒæ•°æ® -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMTPå…¨é¢æµ‹è¯•å·¥å…·</title>
    
    <!-- SEOä¼˜åŒ–æ ‡ç­¾ -->
    <meta name="description" content="åœ¨çº¿SMTPé‚®ä»¶æœåŠ¡å™¨æµ‹è¯•å·¥å…·ï¼Œå¿«é€ŸéªŒè¯é‚®ç®±æœåŠ¡é…ç½®">
    <meta name="keywords" content="é‚®ä»¶æµ‹è¯•,SMTPå·¥å…·,é‚®ç®±éªŒè¯,é‚®ä»¶æœåŠ¡å™¨æ£€æµ‹,SMTPæµ‹è¯•">
    <meta name="robots" content="index,follow">
    <meta property="og:type" content="website">
    <meta property="og:title" content="SMTPé‚®ä»¶æœåŠ¡æµ‹è¯•å·¥å…·">
    <meta property="og:description" content="ä¸“ä¸šæ£€æµ‹SMTPæœåŠ¡å™¨çŠ¶æ€å’Œé‚®ä»¶å‘é€åŠŸèƒ½">
    
    <!-- CDNèµ„æºé¢„è¿æ¥ -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 1200px;
            margin-top: 20px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }
        .form-label {
            font-weight: 600;
            color: #495057;
        }
        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            border: none;
            padding: 12px 24px;
            font-weight: 600;
        }
        .test-output {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', monospace;
            padding: 20px;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .output-line {
            margin: 5px 0;
        }
        .success { color: #4ec9b0; }
        .error { color: #f44747; }
        .warning { color: #ffcc66; }
        .info { color: #9cdcfe; }
        #loadingSpinner {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4" id="page-title">SMTPå…¨é¢æµ‹è¯•å·¥å…·</h1>
        <p class="text-center text-muted mb-4" id="page-subtitle">å®æ—¶æµ‹è¯•å·¥å…· - åŠ¨æ€æ˜¾ç¤ºæµ‹è¯•è¿‡ç¨‹</p>
        
        <!-- æµ‹è¯•æ¨¡å¼é€‰æ‹© -->
        <div class="mb-4 p-3 bg-light rounded">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="testMode" id="modeAuto" value="auto" checked onclick="toggleTestMode()">
                <label class="form-check-label" for="modeAuto">ğŸ” è‡ªåŠ¨æµ‹è¯•æ¨¡å¼</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="testMode" id="modeManual" value="manual" onclick="toggleTestMode()">
                <label class="form-check-label" for="modeManual">âš™ï¸ æ‰‹åŠ¨æµ‹è¯•æ¨¡å¼</label>
            </div>
        </div>

        <!-- SMTPæœåŠ¡å™¨é…ç½® -->
        <div class="row mb-4">
            <div class="col-md-6">
                <label for="smtpServer" class="form-label">ğŸ–¥ï¸ SMTPæœåŠ¡å™¨</label>
                <input type="text" class="form-control" id="smtpServer" placeholder="smtp.example.com">
            </div>
            <div class="col-md-6">
                <label for="username" class="form-label">ğŸ‘¤ ç”¨æˆ·å</label>
                <input type="text" class="form-control" id="username" placeholder="user@example.com">
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <label for="password" class="form-label">ğŸ”‘ å¯†ç </label>
                <input type="password" class="form-control" id="password">
            </div>
            <div class="col-md-6">
                <label for="sender" class="form-label">ğŸ“¤ å‘ä»¶äºº</label>
                <input type="email" class="form-control" id="sender" placeholder="your@email.com">
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <label for="recipient" class="form-label">ğŸ“¥ æ”¶ä»¶äºº</label>
                <input type="email" class="form-control" id="recipient" placeholder="recipient@example.com">
            </div>
        </div>

        <!-- è‡ªåŠ¨æµ‹è¯•é…ç½® -->
        <div id="autoConfig">
            <div class="alert alert-info">
                <strong>è‡ªåŠ¨æ¨¡å¼è¯´æ˜:</strong> å°†è‡ªåŠ¨æµ‹è¯•æ‰€æœ‰å¸¸è§ç«¯å£(25,465,587,2525)å’Œåè®®ç»„åˆ(æ˜æ–‡,STARTTLS,SSL)
            </div>
        </div>

        <!-- æ‰‹åŠ¨æµ‹è¯•é…ç½® -->
        <div id="manualConfig" style="display: none;">
            <div class="row mb-4">
                <div class="col-md-4">
                    <label for="smtpPort" class="form-label">ğŸ”Œ SMTPç«¯å£</label>
                    <input type="number" class="form-control" id="smtpPort" value="587">
                </div>
                <div class="col-md-4">
                    <label for="connectionMethod" class="form-label">ğŸ” è¿æ¥æ–¹å¼</label>
                    <select class="form-select" id="connectionMethod">
                        <option value="plain">æ˜æ–‡è¿æ¥</option>
                        <option value="starttls" selected>STARTTLS</option>
                        <option value="ssl">SSLåŠ å¯†</option>
                    </select>
                </div>
            </div>
            
            <div class="mb-4">
                <label for="emailSubject" class="form-label">ğŸ“ é‚®ä»¶æ ‡é¢˜</label>
                <input type="text" class="form-control" id="emailSubject" value="SMTPæµ‹è¯•é‚®ä»¶">
            </div>
            
            <div class="mb-4">
                <label for="emailBody" class="form-label">ğŸ“„ é‚®ä»¶å†…å®¹</label>
                <textarea class="form-control" id="emailBody" rows="4">è¿™æ˜¯ä¸€å°æµ‹è¯•é‚®ä»¶ï¼Œç”¨äºéªŒè¯SMTPæœåŠ¡å™¨è¿æ¥</textarea>
            </div>
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-center mb-4">
            <button id="testButton" class="btn btn-primary btn-lg me-md-2" onclick="runTest()">ğŸš€ å¼€å§‹æµ‹è¯•</button>
            <div id="loadingSpinner" class="spinner-border text-primary align-self-center" style="display: none;"></div>
        </div>

        <div class="test-output" id="output">
            <div class="output-line info">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
        </div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„JSåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <script>
        // åˆå§‹åŒ–WebSocketè¿æ¥
        const socket = io();  // è¿æ¥åˆ°åŒä¸€ç«¯å£
        
        // ç›‘å¬æ—¥å¿—äº‹ä»¶
        socket.on('log', (data) => {
            log(data.message, data.type);
        });

        // åˆ‡æ¢æµ‹è¯•æ¨¡å¼
        function toggleTestMode() {
            const isAutoMode = document.getElementById('modeAuto').checked;
            document.getElementById('autoConfig').style.display = isAutoMode ? 'block' : 'none';
            document.getElementById('manualConfig').style.display = isAutoMode ? 'none' : 'block';
        }

        // åˆå§‹åŒ–é¡µé¢æ—¶è®¾ç½®æ­£ç¡®æ¨¡å¼
        document.addEventListener('DOMContentLoaded', function() {
            toggleTestMode();
        });

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const line = document.createElement('div');
            line.className = `output-line ${type}`;
            line.textContent = message;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        async function encryptPassword(publicKeyPem, password) {
            try {
                // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
                if (!window.crypto || !window.crypto.subtle) {
                    throw new Error('æµè§ˆå™¨ä¸æ”¯æŒWeb Cryptography API');
                }
                
                // è½¬æ¢PEMæ ¼å¼ä¸ºArrayBuffer
                const pemHeader = '-----BEGIN PUBLIC KEY-----';
                const pemFooter = '-----END PUBLIC KEY-----';
                const pemContents = publicKeyPem
                    .replace(pemHeader, '')
                    .replace(pemFooter, '')
                    .replace(/\s+/g, '');
                const binaryDer = Uint8Array.from(atob(pemContents), c => c.charCodeAt(0));
                
                // å¯¼å…¥å…¬é’¥
                const publicKey = await crypto.subtle.importKey(
                    'spki',
                    binaryDer,
                    { name: 'RSA-OAEP', hash: 'SHA-256' },
                    true,
                    ['encrypt']
                );
                
                // åŠ å¯†æ•°æ®
                const encrypted = await crypto.subtle.encrypt(
                    { name: 'RSA-OAEP' },
                    publicKey,
                    new TextEncoder().encode(password)
                );
                
                // è¿”å›Base64ç¼–ç ç»“æœ
                return btoa(String.fromCharCode(...new Uint8Array(encrypted)));
            } catch (e) {
                console.error('åŠ å¯†è¿‡ç¨‹è¯¦ç»†é”™è¯¯:', {
                    error: e,
                    publicKeyLength: publicKeyPem?.length,
                    passwordLength: password?.length
                });
                throw e;
            }
        }

        async function sendMail(smtpConfig) {
            try {
                // è·å–å…¬é’¥å¹¶åŠ å¯†å¯†ç 
                const configRes = await fetch('/api/config');
                const { public_key } = await configRes.json();
                // åŠ å¯†æ‰€æœ‰æ•æ„Ÿå­—æ®µ
                const encryptField = async (value) => {
                    if (!value || !public_key || !crypto.subtle) return value;
                    try {
                        const encrypted = await encryptPassword(public_key, value);
                        return 'ENCRYPTED:' + encrypted;
                    } catch (e) {
                        console.error(`å­—æ®µåŠ å¯†å¤±è´¥: ${value}`, e);
                        return value; // éå…³é”®å­—æ®µå…è®¸å›é€€
                    }
                };

                // å¯†ç å¼ºåˆ¶åŠ å¯†ï¼Œå…¶ä»–å­—æ®µå¯é€‰
                const passwordToSend = await encryptField(smtpConfig.Password);
                const usernameToSend = await encryptField(smtpConfig.Username);
                const senderToSend = await encryptField(smtpConfig.From);
                const recipientToSend = await encryptField(smtpConfig.To);
                const subjectToSend = await encryptField(smtpConfig.Subject);
                const bodyToSend = await encryptField(smtpConfig.Body);
                
                const response = await fetch('/api/sendmail', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        host: smtpConfig.Host,
                        port: smtpConfig.Port,
                        username: smtpConfig.Username,
                        password: passwordToSend,  // ä½¿ç”¨åŠ å¯†åçš„å¯†ç æˆ–æ˜æ–‡
                        sender: smtpConfig.From,
                        recipient: smtpConfig.To,
                        subject: smtpConfig.Subject,
                        body: smtpConfig.Body,
                        method: smtpConfig.TSL.useSSL ? 'ssl' : (smtpConfig.TSL.useStartTLS ? 'starttls' : 'plain')
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'è¯·æ±‚å¤±è´¥');
                }
                const result = await response.json();
                return result.message;
            } catch (error) {
                throw new Error(error.message || 'ç½‘ç»œè¯·æ±‚å¤±è´¥');
            }
        }

        async function runTest() {
            const button = document.getElementById('testButton');
            const spinner = document.getElementById('loadingSpinner');
            const output = document.getElementById('output');
            
            // é‡ç½®çŠ¶æ€
            output.innerHTML = '';
            button.disabled = true;
            spinner.style.display = 'block';
            
            const isAutoMode = document.getElementById('modeAuto').checked;
            const smtpServer = document.getElementById('smtpServer').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const sender = document.getElementById('sender').value || username;
            const recipient = document.getElementById('recipient').value || username;
            
            if (!smtpServer || !username || !password) {
                log('âŒ è¯·å¡«å†™å®Œæ•´çš„SMTPæœåŠ¡å™¨ã€ç”¨æˆ·åå’Œå¯†ç ', 'error');
                button.disabled = false;
                spinner.style.display = 'none';
                return;
            }

            if (isAutoMode) {
                // è‡ªåŠ¨æ¨¡å¼ - æµ‹è¯•å¤šä¸ªç«¯å£å’Œåè®®
                log(`ğŸš€ å¼€å§‹è‡ªåŠ¨æµ‹è¯• ${smtpServer}`, 'info');
                
                const ports = [25, 465, 587, 2525];
                const methods = ['plain', 'starttls', 'ssl'];
                
                let successCount = 0;
                
                const runSingleTest = (port, method) => {
                    return new Promise((resolve) => {
                        log(`\nğŸ“¡ æµ‹è¯•ç»„åˆ: ç«¯å£ ${port} - ${method.toUpperCase()}`, 'info');
                        
                        const smtpConfig = {
                            Host: smtpServer,
                            Port: port,
                            Username: username,
                            Password: password,
                            From: sender,
                            To: recipient,
                            Subject: `SMTPæµ‹è¯• - ç«¯å£${port} ${method}`,
                            Body: `æµ‹è¯•ç«¯å£ ${port} åè®® ${method}`,
                            SecureToken: "",
                            TSL: {
                                useStartTLS: method === 'starttls',
                                useSSL: method === 'ssl'
                            }
                        };
                        
                        sendMail(smtpConfig)
                            .then(
                                () => {
                                    log(`âœ… ç«¯å£ ${port} + ${method}: æµ‹è¯•æˆåŠŸ`, 'success');
                                    successCount++;
                                    resolve(true);
                                },
                                error => {
                                    log(`âŒ ç«¯å£ ${port} + ${method}: æµ‹è¯•å¤±è´¥`, 'error');
                                    log(`é”™è¯¯è¯¦æƒ…: ${error}`, 'error');
                                    resolve(false);
                                }
                            );
                    });
                };
                
                // æµ‹è¯•æ‰€æœ‰ç«¯å£å’Œåè®®ç»„åˆ
                const tests = [];
                for (const port of ports) {
                    for (const method of methods) {
                        tests.push(runSingleTest(port, method));
                    }
                }
                Promise.all(tests)
                    .then(() => {
                        log(`\nğŸ“Š æµ‹è¯•å®Œæˆ: ${successCount}/${ports.length * methods.length} æˆåŠŸ`, 'info');
                        button.disabled = false;
                        spinner.style.display = 'none';
                    });
                
            } else {
                // æ‰‹åŠ¨æ¨¡å¼ - æµ‹è¯•æŒ‡å®šé…ç½®
                const port = document.getElementById('smtpPort').value;
                const method = document.getElementById('connectionMethod').value;
                const subject = document.getElementById('emailSubject').value;
                const body = document.getElementById('emailBody').value;
                
                log(`ğŸš€ å¼€å§‹æ‰‹åŠ¨æµ‹è¯• ${smtpServer}:${port} (${method})`, 'info');
                
                const smtpConfig = {
                    Host: smtpServer,
                    Port: port,
                    Username: username,
                    Password: password,
                    From: sender,
                    To: recipient,
                    Subject: subject,
                    Body: body,
                    SecureToken: "",
                    TSL: {
                        useStartTLS: method === 'starttls',
                        useSSL: method === 'ssl'
                    }
                };

                // æ‰§è¡Œæµ‹è¯•
                sendMail(smtpConfig)
                    .then(
                        () => log('âœ… æµ‹è¯•æˆåŠŸ: é‚®ä»¶å·²å‘é€', 'success'),
                        error => {
                            log('âŒ æµ‹è¯•å¤±è´¥', 'error');
                            log(`é”™è¯¯è¯¦æƒ…: ${error}`, 'error');
                        }
                    )
                    .finally(() => {
                        button.disabled = false;
                        spinner.style.display = 'none';
                        log('æµ‹è¯•å®Œæˆ', 'info');
                    });
            }
        }
    </script>

    <!-- åŠ¨æ€ç‰ˆæƒå£°æ˜ -->
    <div class="text-center mt-4">
        <h5 class="copyright-text">
            <span>Â©</span> 
            <span id="copyright-year">2026</span>
            <span id="copyright-text">SMTPæµ‹è¯•å·¥å…·</span>
        </h5>
    </div>

    <script>
    // ä»åç«¯APIè·å–é…ç½®
    async function loadConfig() {
        try {
            const response = await fetch('/api/config');
            if (response.ok) {
                const config = await response.json();
                
                // è®¾ç½®é¡µé¢æ ‡é¢˜
                document.getElementById('page-title').textContent = config.page.title;
                document.getElementById('page-subtitle').textContent = config.page.subtitle;
                
                // è®¾ç½®favicon
                if (config.favicon_url) {
                    const link = document.createElement('link');
                    link.rel = 'icon';
                    link.href = config.favicon_url;
                    document.head.appendChild(link);
                }
                
                // è®¾ç½®ç‰ˆæƒä¿¡æ¯
                const copyright = config.copyright;
                const yearEl = document.getElementById('copyright-year');
                const textEl = document.getElementById('copyright-text');
                yearEl.textContent = copyright.year;
                
                if (copyright.link) {
                    const link = document.createElement('a');
                    link.href = copyright.link;
                    link.className = 'gradient-text text-decoration-none';
                    link.textContent = copyright.text;
                    link.target = '_blank';  // æ–°çª—å£æ‰“å¼€
                    link.rel = 'noopener noreferrer';  // å®‰å…¨å±æ€§
                    textEl.replaceWith(link);
                } else {
                    textEl.textContent = copyright.text;
                    textEl.className = 'gradient-text';
                }
            }
        } catch (error) {
            console.log('åŠ è½½é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
        }
    }
    
    document.addEventListener('DOMContentLoaded', loadConfig);
    </script>

    <style>
    .copyright-text {
        margin: 20px 0;
        font-size: 14px;
        color: #6c757d;
    }
    .gradient-text {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: bold;
        margin-left: 5px;
    }
    </style>
</body>
</html>